<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Iglesia Impacto Pro - IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <style>
        body { 
            background-color: #f4f7f6; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card { 
            border-radius: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: none;
            transition: transform 0.2s;
            margin-bottom: 1rem;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .header-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }
        #video-container { 
            position: relative; 
            width: 100%; 
            max-width: 450px; 
            margin: auto; 
            overflow: hidden; 
            border-radius: 12px; 
            background: #000;
            border: 3px solid #dee2e6;
            transition: border-color 0.3s;
        }
        #video-container.activo {
            border-color: #28a745;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        video { 
            width: 100%; 
            height: auto; 
            display: block;
        }
        canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            pointer-events: none;
        }
        .status-ia { 
            font-size: 0.85rem; 
            color: #666;
            padding: 8px;
            border-radius: 8px;
            background-color: #f8f9fa;
            margin: 10px 0;
        }
        .counter-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        .btn-custom {
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .total-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .total-number {
            font-size: 2.8rem;
            font-weight: bold;
        }
        .history-item {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
        }
        .detection-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
        }
        .badge-adult { background: #3498db; color: white; }
        .badge-child { background: #2ecc71; color: white; }
        .badge-car { background: #e74c3c; color: white; }
        
        @media (max-width: 768px) {
            .counter-display { font-size: 2rem; }
            .total-number { font-size: 2.2rem; }
            .btn-custom { padding: 8px 16px; }
        }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4 header-title">‚õ™ Registro Inteligente Iglesia Impacto Pro</h2>
    
    <!-- Tarjeta de IA -->
    <div class="card p-4 mb-4">
        <h5 class="card-title text-center mb-3">üéØ Esc√°ner de Inteligencia Artificial</h5>
        
        <div id="video-container">
            <video id="video" autoplay playsinline muted></video>
        </div>
        
        <div id="status" class="status-ia text-center">Cargando modelo de IA...</div>
        
        <div class="row g-2 mb-3">
            <div class="col-6">
                <button class="btn btn-custom btn-primary w-100" id="btn-detectar" onclick="detectarAhora()" disabled>
                    ‚ú® Contar con IA
                </button>
            </div>
            <div class="col-6">
                <select class="form-select" id="modo-deteccion">
                    <option value="normal">Normal (Personas + Veh√≠culos)</option>
                    <option value="solo-personas">Solo Personas</option>
                    <option value="solo-vehiculos">Solo Veh√≠culos</option>
                </select>
            </div>
        </div>
        
        <div class="text-center small text-muted">
            <i>Posiciona la c√°mara hacia el √°rea a contar y presiona "Contar con IA"</i>
        </div>
    </div>

    <!-- Resumen Total -->
    <div class="card p-3 mb-4 total-card">
        <h6 class="text-center text-white">üìä RESUMEN TOTAL</h6>
        <div class="row text-center">
            <div class="col-6">
                <small class="text-white-50">Total Personas</small>
                <div class="total-number" id="total-personas">0</div>
            </div>
            <div class="col-6">
                <small class="text-white-50">Total Veh√≠culos</small>
                <div class="total-number" id="total-carros">0</div>
            </div>
        </div>
    </div>

    <!-- Contadores Manuales -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card p-3 text-center h-100">
                <h6 class="text-primary">üë®‚Äçüë©‚Äçüë¶ Adultos</h6>
                <div class="counter-display" id="adultos-val">0</div>
                <div class="d-flex justify-content-between mt-2">
                    <button class="btn btn-danger btn-custom" onclick="cambiar('adultos', -1)" style="width: 48%;">-</button>
                    <button class="btn btn-success btn-custom" onclick="cambiar('adultos', 1)" style="width: 48%;">+</button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 text-center h-100">
                <h6 class="text-success">üë∂ Ni√±os</h6>
                <div class="counter-display" id="ni√±os-val">0</div>
                <div class="d-flex justify-content-between mt-2">
                    <button class="btn btn-danger btn-custom" onclick="cambiar('ni√±os', -1)" style="width: 48%;">-</button>
                    <button class="btn btn-success btn-custom" onclick="cambiar('ni√±os', 1)" style="width: 48%;">+</button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 text-center h-100">
                <h6 class="text-danger">üöó Veh√≠culos</h6>
                <div class="counter-display" id="carros-val">0</div>
                <div class="d-flex justify-content-between mt-2">
                    <button class="btn btn-danger btn-custom" onclick="cambiar('carros', -1)" style="width: 48%;">-</button>
                    <button class="btn btn-success btn-custom" onclick="cambiar('carros', 1)" style="width: 48%;">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Detecciones -->
    <div class="card p-3 mb-4" id="historial-container" style="display: none;">
        <h6>üìù Historial de Detecciones</h6>
        <div id="historial-lista" class="mt-2">
            <!-- Historial se carga aqu√≠ -->
        </div>
    </div>

    <!-- Botones de Acci√≥n -->
    <div class="row g-2">
        <div class="col-md-6">
            <button class="btn btn-dark btn-custom w-100 mb-2" onclick="exportarCSV()">
                üíæ Guardar Reporte CSV
            </button>
        </div>
        <div class="col-md-6">
            <button class="btn btn-outline-danger btn-custom w-100 mb-2" onclick="confirmarLimpiar()">
                üóëÔ∏è Limpiar Conteo
            </button>
        </div>
    </div>

    <!-- Informaci√≥n del Sistema -->
    <div class="text-center mt-4 small text-muted">
        <p>Sistema de Registro Inteligente v2.0 | Iglesia Impacto Pro<br>
        <span id="ultima-actualizacion"></span></p>
    </div>
</div>

<script>
    // Variables globales
    let detector;
    let video;
    let procesando = false;
    let counts = { adultos: 0, ni√±os: 0, carros: 0 };
    let historial = [];
    let ultimaDeteccion = null;

    // Inicializar c√°mara e IA
    async function setup() {
        try {
            video = document.getElementById('video');
            const status = document.getElementById('status');
            
            // Verificar si hay c√°mara disponible
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error("C√°mara no disponible en este dispositivo");
            }
            
            status.innerText = "üì∑ Inicializando c√°mara...";
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }, 
                audio: false 
            });
            
            video.srcObject = stream;
            
            // Esperar a que el video est√© listo
            await new Promise(resolve => {
                video.onloadedmetadata = () => {
                    video.play();
                    resolve();
                };
            });

            status.innerText = "üß† Cargando modelo de IA (COCO-SSD)...";
            
            // Cargar modelo con timeout
            const modelLoadPromise = new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject(new Error("Timeout cargando modelo")), 15000);
                
                detector = ml5.objectDetector('cocossd', { scoreThreshold: 0.5 }, (err) => {
                    clearTimeout(timeout);
                    if (err) reject(err);
                    else resolve();
                });
            });

            await modelLoadPromise;
            
            // Activar indicador visual
            document.getElementById('video-container').classList.add('activo');
            status.innerHTML = "‚úÖ <strong>IA Lista para contar</strong>";
            document.getElementById('btn-detectar').disabled = false;
            
            console.log("Sistema de IA inicializado correctamente");
            
        } catch (error) {
            console.error("Error en setup:", error);
            const status = document.getElementById('status');
            status.innerHTML = `‚ùå <strong>Error:</strong> ${error.message}`;
            status.style.color = "#dc3545";
            document.getElementById('btn-detectar').disabled = true;
            
            // Mostrar instrucciones alternativas
            alert("No se pudo cargar la c√°mara o el modelo de IA. Por favor, use los botones manuales.");
        }
    }

    // Funci√≥n principal de detecci√≥n
    async function detectarAhora() {
        if (procesando) {
            alert("‚ö†Ô∏è Ya se est√° procesando una detecci√≥n. Espere un momento.");
            return;
        }
        
        if (!detector) {
            alert("‚ùå El modelo de IA no est√° listo todav√≠a.");
            return;
        }
        
        procesando = true;
        const status = document.getElementById('status');
        const btnDetectar = document.getElementById('btn-detectar');
        const modo = document.getElementById('modo-deteccion').value;
        
        status.innerHTML = "üîç <strong>Analizando imagen...</strong>";
        btnDetectar.disabled = true;
        
        try {
            detector.detect(video, (err, results) => {
                procesando = false;
                btnDetectar.disabled = false;
                
                if (err) {
                    console.error("Error en detecci√≥n:", err);
                    status.innerHTML = "‚ùå <strong>Error en detecci√≥n</strong>";
                    alert("Error en detecci√≥n: " + err.message);
                    return;
                }
                
                let a = 0, n = 0, c = 0;
                const detecciones = [];
                
                results.forEach(obj => {
                    if (obj.confidence < 0.6) return; // Filtrar baja confianza
                    
                    if (obj.label === 'person') {
                        // Mejor l√≥gica para distinguir adultos/ni√±os
                        const alturaRelativa = obj.height / video.videoHeight;
                        const area = obj.width * obj.height;
                        
                        // Usar m√∫ltiples criterios
                        if (alturaRelativa < 0.4 && area < 10000) {
                            n++;
                            detecciones.push({tipo: 'ni√±o', confianza: obj.confidence});
                        } else {
                            a++;
                            detecciones.push({tipo: 'adulto', confianza: obj.confidence});
                        }
                    }
                    if ((obj.label === 'car' || obj.label === 'truck') && modo !== 'solo-personas') {
                        c++;
                        detecciones.push({tipo: 'veh√≠culo', confianza: obj.confidence});
                    }
                });
                
                // Filtrar seg√∫n modo seleccionado
                if (modo === 'solo-personas') c = 0;
                if (modo === 'solo-vehiculos') { a = 0; n = 0; }
                
                ultimaDeteccion = { adultos: a, ni√±os: n, carros: c, timestamp: new Date() };
                
                if (a > 0 || n > 0 || c > 0) {
                    mostrarConfirmacionDeteccion(a, n, c, detecciones);
                } else {
                    status.innerHTML = "üëÅÔ∏è <strong>No se detectaron objetos</strong>";
                    alert("No se detectaron personas ni veh√≠culos en la imagen. Aseg√∫rese de apuntar la c√°mara correctamente.");
                }
            });
        } catch (error) {
            procesando = false;
            btnDetectar.disabled = false;
            status.innerHTML = "‚ùå <strong>Error en procesamiento</strong>";
            alert("Error: " + error.message);
        }
    }

    // Mostrar confirmaci√≥n de detecci√≥n
    function mostrarConfirmacionDeteccion(a, n, c, detecciones) {
        const status = document.getElementById('status');
        
        // Crear mensaje detallado
        let mensaje = `üéØ DETECCI√ìN DE IA\n\n`;
        mensaje += `‚úÖ Adultos detectados: ${a}\n`;
        mensaje += `üë∂ Ni√±os detectados: ${n}\n`;
        mensaje += `üöó Veh√≠culos detectados: ${c}\n`;
        mensaje += `\nConfianza promedio: ${calcularConfianzaPromedio(detecciones)}%\n`;
        mensaje += `\n¬øDesea agregar estos valores al conteo total?`;
        
        if (confirm(mensaje)) {
            // Agregar al conteo
            counts.adultos += a;
            counts.ni√±os += n;
            counts.carros += c;
            
            // Guardar en historial
            guardarEnHistorial(a, n, c, detecciones);
            
            // Actualizar UI
            actualizarUI();
            
            // Mostrar notificaci√≥n
            status.innerHTML = `‚úÖ <strong>¬°${a+n} personas y ${c} veh√≠culos agregados!</strong>`;
            
            // Mostrar historial
            mostrarHistorial();
            
            // Efecto visual
            mostrarEfectoAgregado(a, n, c);
        } else {
            status.innerHTML = "‚úÖ <strong>IA Lista para contar</strong>";
        }
    }

    // Calcular confianza promedio
    function calcularConfianzaPromedio(detecciones) {
        if (detecciones.length === 0) return 0;
        const total = detecciones.reduce((sum, det) => sum + det.confianza, 0);
        return Math.round((total / detecciones.length) * 100);
    }

    // Efecto visual al agregar
    function mostrarEfectoAgregado(a, n, c) {
        const elementos = [];
        if (a > 0) elementos.push('adultos-val');
        if (n > 0) elementos.push('ni√±os-val');
        if (c > 0) elementos.push('carros-val');
        
        elementos.forEach(id => {
            const elemento = document.getElementById(id);
            elemento.classList.add('text-success');
            setTimeout(() => elemento.classList.remove('text-success'), 1000);
        });
    }

    // Guardar en historial
    function guardarEnHistorial(a, n, c, detecciones = []) {
        const timestamp = new Date();
        historial.unshift({
            timestamp: timestamp.toISOString(),
            adultos: a,
            ni√±os: n,
            carros: c,
            total: a + n,
            detecciones: detecciones,
            modo: document.getElementById('modo-deteccion').value
        });
        
        // Limitar historial a 20 elementos
        if (historial.length > 20) {
            historial = historial.slice(0, 20);
        }
        
        // Actualizar localStorage
        guardarEnStorage();
    }

    // Mostrar historial
    function mostrarHistorial() {
        const container = document.getElementById('historial-container');
        const lista = document.getElementById('historial-lista');
        
        if (historial.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        lista.innerHTML = '';
        
        historial.slice(0, 5).forEach((item, index) => {
            const fecha = new Date(item.timestamp);
            const hora = fecha.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div class="d-flex justify-content-between">
                    <small><strong>${hora}</strong></small>
                    <small class="text-muted">${fecha.toLocaleDateString()}</small>
                </div>
                <div class="mt-1">
                    <span class="badge-adult detection-badge">üë• ${item.adultos}</span>
                    <span class="badge-child detection-badge">üë∂ ${item.ni√±os}</span>
                    <span class="badge-car detection-badge">üöó ${item.carros}</span>
                    <span class="badge bg-secondary detection-badge">Total: ${item.total}</span>
                </div>
            `;
            lista.appendChild(div);
        });
    }

    // Cambiar contadores manualmente
    function cambiar(tipo, valor) {
        const nuevoValor = counts[tipo] + valor;
        
        if (nuevoValor < 0) {
            alert("‚ùå El valor no puede ser negativo");
            return;
        }
        
        counts[tipo] = nuevoValor;
        actualizarUI();
        guardarEnStorage();
        
        // Peque√±o feedback visual
        const elemento = document.getElementById(`${tipo}-val`);
        elemento.classList.add(valor > 0 ? 'text-success' : 'text-danger');
        setTimeout(() => elemento.classList.remove('text-success', 'text-danger'), 300);
    }

    // Actualizar toda la interfaz
    function actualizarUI() {
        // Actualizar contadores individuales
        document.getElementById('adultos-val').innerText = counts.adultos;
        document.getElementById('ni√±os-val').innerText = counts.ni√±os;
        document.getElementById('carros-val').innerText = counts.carros;
        
        // Actualizar totales
        const totalPersonas = counts.adultos + counts.ni√±os;
        document.getElementById('total-personas').innerText = totalPersonas;
        document.getElementById('total-carros').innerText = counts.carros;
        
        // Actualizar √∫ltima actualizaci√≥n
        document.getElementById('ultima-actualizacion').innerText = 
            `√öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}`;
    }

    // Confirmar limpieza
    function confirmarLimpiar() {
        const total = counts.adultos + counts.ni√±os + counts.carros;
        
        if (total === 0) {
            alert("El conteo ya est√° en cero.");
            return;
        }
        
        if (confirm(`‚ö†Ô∏è ¬øEST√Å SEGURO DE REINICIAR EL CONTEO?\n\nActualmente tiene:\nüë• ${counts.adultos + counts.ni√±os} personas\nüöó ${counts.carros} veh√≠culos\n\nEsta acci√≥n no se puede deshacer.`)) {
            counts = { adultos: 0, ni√±os: 0, carros: 0 };
            historial = [];
            actualizarUI();
            document.getElementById('historial-container').style.display = 'none';
            localStorage.removeItem('iglesiaConteo');
            alert("‚úÖ Conteo reiniciado exitosamente.");
        }
    }

    // Exportar a CSV
    function exportarCSV() {
        const fecha = new Date();
        const fechaStr = fecha.toISOString().split('T')[0];
        const horaStr = fecha.toTimeString().split(' ')[0].replace(/:/g, '-');
        
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Encabezado
        csvContent += "REPORTE DE ASISTENCIA - IGLESIA IMPACTO PRO\n";
        csvContent += `Fecha de generaci√≥n: ${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString()}\n`;
        csvContent += "===========================================\n\n";
        
        // Resumen general
        csvContent += "RESUMEN GENERAL\n";
        csvContent += "Categor√≠a,Cantidad\n";
        csvContent += `Adultos,${counts.adultos}\n`;
        csvContent += `Ni√±os,${counts.ni√±os}\n`;
        csvContent += `Total Personas,${counts.adultos + counts.ni√±os}\n`;
        csvContent += `Veh√≠culos,${counts.carros}\n\n`;
        
        // Historial de detecciones
        if (historial.length > 0) {
            csvContent += "HISTORIAL DE DETECCIONES POR IA\n";
            csvContent += "Fecha,Hora,Adultos,Ni√±os,Veh√≠culos,Total Personas,Modo\n";
            
            historial.forEach(item => {
                const d = new Date(item.timestamp);
                csvContent += `${d.toLocaleDateString()},${d.toLocaleTimeString()},${item.adultos},${item.ni√±os},${item.carros},${item.total},${item.modo}\n`;
            });
            csvContent += "\n";
        }
        
        // Metadata
        csvContent += "METADATA\n";
        csvContent += `Total detecciones IA,${historial.length}\n`;
        csvContent += `Modelo utilizado,COCO-SSD\n`;
        csvContent += `Versi√≥n sistema,2.0\n`;
        
        // Crear y descargar archivo
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `asistencia_iglesia_${fechaStr}_${horaStr}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Feedback al usuario
        alert(`‚úÖ Reporte generado exitosamente:\nasistencia_iglesia_${fechaStr}_${horaStr}.csv`);
    }

    // Guardar en localStorage
    function guardarEnStorage() {
        const data = {
            counts: counts,
            historial: historial,
            fechaGuardado: new Date().toISOString(),
            version: '2.0'
        };
        localStorage.setItem('iglesiaConteo', JSON.stringify(data));
    }

    // Cargar desde localStorage
    function cargarDesdeStorage() {
        try {
            const guardado = localStorage.getItem('iglesiaConteo');
            if (guardado) {
                const data = JSON.parse(guardado);
                counts = data.counts || counts;
                historial = data.historial || historial;
                actualizarUI();
                
                if (historial.length > 0) {
                    mostrarHistorial();
                }
                
                console.log("Datos cargados desde almacenamiento local");
            }
        } catch (e) {
            console.error("Error cargando datos:", e);
        }
    }

    // Limpiar recursos al cerrar
    window.addEventListener('beforeunload', () => {
        if (video && video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        guardarEnStorage();
    });

    // Auto-guardar cada minuto
    setInterval(guardarEnStorage, 60000);

    // Inicializar cuando cargue la p√°gina
    window.addEventListener('DOMContentLoaded', () => {
        cargarDesdeStorage();
        setup();
        
        // Mostrar historial si existe
        if (historial.length > 0) {
            mostrarHistorial();
        }
    });
</script>
</body>
            </html>
