<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Iglesia Impacto Pro - IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Versi√≥n alternativa de ml5.js -->
    <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
    <style>
        body { 
            background-color: #f4f7f6; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card { 
            border-radius: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: none;
            transition: transform 0.2s;
            margin-bottom: 1rem;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .header-title {
            color: #2c3e50;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        #video-container { 
            position: relative; 
            width: 100%; 
            max-width: 450px; 
            margin: auto; 
            overflow: hidden; 
            border-radius: 12px; 
            background: #000;
            border: 3px solid #dee2e6;
            transition: border-color 0.3s;
            min-height: 300px;
        }
        #video-container.activo {
            border-color: #28a745;
        }
        video { 
            width: 100%; 
            height: auto; 
            display: block;
            transform: scaleX(-1); /* Espejo para parecer espejo */
        }
        .canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transform: scaleX(-1); /* Igual que el video */
        }
        .status-ia { 
            font-size: 0.85rem; 
            color: #666;
            padding: 8px;
            border-radius: 8px;
            background-color: #f8f9fa;
            margin: 10px 0;
        }
        .counter-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
            transition: all 0.3s;
        }
        .btn-custom {
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.3s;
            border: none;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .total-card {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
        }
        .total-number {
            font-size: 2.8rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        .history-item {
            border-left: 4px solid #3498db;
            padding: 10px 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .detection-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
            color: white;
        }
        .badge-adult { background: #3498db; }
        .badge-child { background: #2ecc71; }
        .badge-car { background: #e74c3c; }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #e74c3c;
            background-color: #ffebee;
            border: 1px solid #e74c3c;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .success-message {
            color: #27ae60;
            background-color: #e8f5e9;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .manual-mode {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            color: #856404;
        }
        
        @media (max-width: 768px) {
            .counter-display { font-size: 2rem; }
            .total-number { font-size: 2.2rem; }
            .btn-custom { padding: 8px 16px; }
            #video-container { min-height: 250px; }
        }
        
        .detection-info {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }
        
        .instructions {
            background-color: #e8f4f8;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .instructions h6 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            margin-bottom: 0;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4 header-title">‚õ™ Sistema de Registro Inteligente</h2>
    
    <!-- Instrucciones -->
    <div class="instructions">
        <h6>üìã Instrucciones R√°pidas:</h6>
        <ul>
            <li>Permita el acceso a la c√°mara cuando se le solicite</li>
            <li>Apunte la c√°mara hacia el √°rea donde desea contar personas/veh√≠culos</li>
            <li>Presione "Contar con IA" para activar el reconocimiento</li>
            <li>Use los botones +/- para ajustes manuales</li>
            <li>Exporte el reporte al finalizar</li>
        </ul>
    </div>
    
    <!-- Tarjeta de IA -->
    <div class="card p-4 mb-4">
        <h5 class="card-title text-center mb-3">üéØ Esc√°ner de Inteligencia Artificial</h5>
        
        <div id="video-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas-overlay" class="canvas-overlay"></canvas>
            <div id="video-placeholder" class="d-flex justify-content-center align-items-center text-white" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50;">
                <div class="text-center">
                    <div class="loading-spinner"></div>
                    <p class="mt-2">Inicializando c√°mara...</p>
                </div>
            </div>
        </div>
        
        <div id="status" class="status-ia text-center">
            <span class="loading-spinner"></span>
            <span id="status-text">Inicializando sistema...</span>
        </div>
        
        <!-- Modo Manual (se muestra si falla la IA) -->
        <div id="manual-mode-alert" class="manual-mode" style="display: none;">
            <strong>‚ö†Ô∏è Modo Manual Activado</strong>
            <p class="mb-0">El sistema de IA no est√° disponible. Use los botones manuales para el conteo.</p>
        </div>
        
        <div class="row g-2 mb-3">
            <div class="col-12 col-md-8">
                <button class="btn btn-custom btn-primary w-100 mb-2" id="btn-detectar" onclick="detectarAhora()" disabled>
                    <span id="btn-icon">‚ú®</span>
                    <span id="btn-text">Contar con IA</span>
                </button>
            </div>
            <div class="col-12 col-md-4">
                <select class="form-select" id="modo-deteccion">
                    <option value="normal">Normal</option>
                    <option value="solo-personas">Solo Personas</option>
                    <option value="solo-vehiculos">Solo Veh√≠culos</option>
                </select>
            </div>
        </div>
        
        <div class="detection-info">
            <i>La IA puede detectar personas y veh√≠culos. Los ni√±os se identifican por su altura relativa.</i>
        </div>
    </div>

    <!-- Resumen Total -->
    <div class="card p-3 mb-4 total-card">
        <h6 class="text-center text-white mb-3">üìä RESUMEN TOTAL DEL EVENTO</h6>
        <div class="row text-center">
            <div class="col-6">
                <small class="text-white-50">Total Personas</small>
                <div class="total-number" id="total-personas">0</div>
            </div>
            <div class="col-6">
                <small class="text-white-50">Total Veh√≠culos</small>
                <div class="total-number" id="total-carros">0</div>
            </div>
        </div>
        <div class="text-center mt-2">
            <small class="text-white-50" id="timestamp">√öltima actualizaci√≥n: --:--:--</small>
        </div>
    </div>

    <!-- Contadores Manuales -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card p-3 text-center h-100">
                <h6 class="text-primary">üë®‚Äçüë©‚Äçüë¶ Adultos</h6>
                <div class="counter-display" id="adultos-val">0</div>
                <div class="d-flex justify-content-between mt-2">
                    <button class="btn btn-danger btn-custom" onclick="cambiar('adultos', -1)" style="width: 48%;">-</button>
                    <button class="btn btn-success btn-custom" onclick="cambiar('adultos', 1)" style="width: 48%;">+</button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 text-center h-100">
                <h6 class="text-success">üë∂ Ni√±os</h6>
                <div class="counter-display" id="ni√±os-val">0</div>
                <div class="d-flex justify-content-between mt-2">
                    <button class="btn btn-danger btn-custom" onclick="cambiar('ni√±os', -1)" style="width: 48%;">-</button>
                    <button class="btn btn-success btn-custom" onclick="cambiar('ni√±os', 1)" style="width: 48%;">+</button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 text-center h-100">
                <h6 class="text-danger">üöó Veh√≠culos</h6>
                <div class="counter-display" id="carros-val">0</div>
                <div class="d-flex justify-content-between mt-2">
                    <button class="btn btn-danger btn-custom" onclick="cambiar('carros', -1)" style="width: 48%;">-</button>
                    <button class="btn btn-success btn-custom" onclick="cambiar('carros', 1)" style="width: 48%;">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Detecciones -->
    <div class="card p-3 mb-4" id="historial-container" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">üìù Historial Reciente</h6>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleHistorial()">Ver Todo</button>
        </div>
        <div id="historial-lista" class="mt-2">
            <!-- Historial se carga aqu√≠ -->
        </div>
    </div>

    <!-- Botones de Acci√≥n -->
    <div class="row g-2">
        <div class="col-md-6">
            <button class="btn btn-dark btn-custom w-100 mb-2" onclick="exportarCSV()">
                üíæ Exportar Reporte CSV
            </button>
        </div>
        <div class="col-md-6">
            <button class="btn btn-outline-danger btn-custom w-100 mb-2" onclick="confirmarLimpiar()">
                üóëÔ∏è Reiniciar Conteo
            </button>
        </div>
    </div>

    <!-- Informaci√≥n del Sistema -->
    <div class="text-center mt-4 small text-muted">
        <p>Sistema de Registro Inteligente v2.2 | Iglesia Impacto Pro<br>
        <span id="system-info">Cargando informaci√≥n del sistema...</span></p>
    </div>
</div>

<script>
    // Variables globales
    let detector = null;
    let video = null;
    let canvas = null;
    let ctx = null;
    let procesando = false;
    let modoIA = false; // Indica si la IA est√° disponible
    let counts = { adultos: 0, ni√±os: 0, carros: 0 };
    let historial = [];
    let detectionHistory = [];

    // Elementos del DOM
    let statusElement, statusText, btnDetectar, btnIcon, btnText;

    // Inicializar elementos del DOM
    function initDOMElements() {
        statusElement = document.getElementById('status');
        statusText = document.getElementById('status-text');
        btnDetectar = document.getElementById('btn-detectar');
        btnIcon = document.getElementById('btn-icon');
        btnText = document.getElementById('btn-text');
    }

    // Verificar si ml5 est√° disponible
    function checkML5() {
        return typeof ml5 !== 'undefined';
    }

    // Inicializar c√°mara
    async function setupCamera() {
        try {
            updateStatus("üì∑ Solicitando acceso a la c√°mara...");
            
            video = document.getElementById('video');
            const placeholder = document.getElementById('video-placeholder');
            
            // Verificar si hay c√°mara disponible
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error("Su navegador no soporta el acceso a la c√°mara");
            }
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment",
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }, 
                audio: false 
            });
            
            video.srcObject = stream;
            
            // Esperar a que el video est√© listo
            await new Promise((resolve, reject) => {
                video.onloadedmetadata = () => {
                    video.play();
                    
                    // Configurar canvas para dibujar
                    canvas = document.getElementById('canvas-overlay');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx = canvas.getContext('2d');
                    
                    // Ocultar placeholder y mostrar video
                    placeholder.style.display = 'none';
                    resolve();
                };
                
                video.onerror = reject;
                
                // Timeout de seguridad
                setTimeout(() => reject(new Error("Timeout al cargar video")), 5000);
            });
            
            updateStatus("‚úÖ C√°mara lista");
            return true;
            
        } catch (error) {
            console.error("Error en c√°mara:", error);
            updateStatus(`‚ùå Error en c√°mara: ${error.message}`, 'error');
            return false;
        }
    }

    // Inicializar modelo de IA
    async function setupModel() {
        try {
            if (!checkML5()) {
                throw new Error("La biblioteca ml5.js no se carg√≥ correctamente");
            }
            
            updateStatus("üß† Cargando modelo de IA...");
            
            // Intentar cargar el modelo COCO-SSD
            detector = await ml5.objectDetector('cocossd');
            
            modoIA = true;
            updateStatus("‚úÖ IA lista para detectar personas y veh√≠culos");
            document.getElementById('video-container').classList.add('activo');
            
            // Habilitar bot√≥n de detecci√≥n
            btnDetectar.disabled = false;
            btnIcon.textContent = "‚ú®";
            btnText.textContent = "Contar con IA";
            
            return true;
            
        } catch (error) {
            console.error("Error al cargar modelo:", error);
            modoIA = false;
            
            // Mostrar alerta de modo manual
            document.getElementById('manual-mode-alert').style.display = 'block';
            
            // Cambiar texto del bot√≥n
            btnIcon.textContent = "üëÅÔ∏è";
            btnText.textContent = "Usar C√°mara (Modo Manual)";
            btnDetectar.disabled = false;
            
            updateStatus("‚ö†Ô∏è Usando modo manual - IA no disponible", 'warning');
            return false;
        }
    }

    // Actualizar estado
    function updateStatus(message, type = 'info') {
        const spinner = statusElement.querySelector('.loading-spinner');
        
        statusText.textContent = message;
        
        // Remover clases previas
        statusElement.classList.remove('error-message', 'success-message', 'status-ia');
        
        // Aplicar clase seg√∫n tipo
        if (type === 'error') {
            statusElement.classList.add('error-message');
            spinner.style.display = 'none';
        } else if (type === 'success') {
            statusElement.classList.add('success-message');
            spinner.style.display = 'none';
        } else if (type === 'warning') {
            statusElement.classList.add('manual-mode');
            spinner.style.display = 'inline-block';
            spinner.style.borderTopColor = '#ffc107';
        } else {
            statusElement.classList.add('status-ia');
            spinner.style.display = 'inline-block';
            spinner.style.borderTopColor = '#3498db';
        }
        
        // Actualizar timestamp
        updateTimestamp();
    }

    // Actualizar timestamp
    function updateTimestamp() {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        document.getElementById('timestamp').textContent = `√öltima actualizaci√≥n: ${timeString}`;
    }

    // Funci√≥n principal de detecci√≥n
    async function detectarAhora() {
        if (procesando) {
            alert("‚ö†Ô∏è Ya se est√° procesando una detecci√≥n. Espere un momento.");
            return;
        }
        
        if (!modoIA) {
            // Modo manual: solo mostrar vista de c√°mara
            alert("üì∏ Modo manual activado. Use los botones +/- para contar manualmente mientras observa la c√°mara.");
            return;
        }
        
        procesando = true;
        updateStatus("üîç Analizando imagen con IA...");
        btnDetectar.disabled = true;
        
        try {
            // Realizar detecci√≥n
            const results = await detector.detect(video);
            
            let adultos = 0, ni√±os = 0, carros = 0;
            const detecciones = [];
            
            results.forEach(detection => {
                if (detection.confidence < 0.4) return; // Filtro de confianza
                
                const [x, y, width, height] = detection.bbox;
                const label = detection.label.toLowerCase();
                
                // Dibujar en canvas
                drawDetection(x, y, width, height, label, detection.confidence);
                
                if (label === 'person') {
                    // Distinguir adulto/ni√±o por altura relativa
                    if (height < video.videoHeight * 0.4) {
                        ni√±os++;
                        detecciones.push({tipo: 'ni√±o', confianza: detection.confidence});
                    } else {
                        adultos++;
                        detecciones.push({tipo: 'adulto', confianza: detection.confidence});
                    }
                } else if ((label === 'car' || label === 'truck') && 
                          document.getElementById('modo-deteccion').value !== 'solo-personas') {
                    carros++;
                    detecciones.push({tipo: 'veh√≠culo', confianza: detection.confidence});
                }
            });
            
            // Filtrar seg√∫n modo seleccionado
            const modo = document.getElementById('modo-deteccion').value;
            if (modo === 'solo-personas') carros = 0;
            if (modo === 'solo-vehiculos') { adultos = 0; ni√±os = 0; }
            
            // Guardar para historial
            detectionHistory.push({
                timestamp: new Date().toISOString(),
                resultados: results,
                conteo: { adultos, ni√±os, carros }
            });
            
            // Mostrar resultados
            mostrarResultadosDeteccion(adultos, ni√±os, carros, detecciones);
            
        } catch (error) {
            console.error("Error en detecci√≥n:", error);
            updateStatus("‚ùå Error en detecci√≥n", 'error');
            alert("Error al procesar la imagen. Intente nuevamente.");
        } finally {
            procesando = false;
            btnDetectar.disabled = false;
        }
    }

    // Dibujar detecci√≥n en canvas
    function drawDetection(x, y, width, height, label, confidence) {
        if (!ctx) return;
        
        // Determinar color
        let color;
        if (label === 'person') {
            color = height < video.videoHeight * 0.4 ? '#2ecc71' : '#3498db';
        } else if (label === 'car' || label === 'truck') {
            color = '#e74c3c';
        } else {
            color = '#f39c12';
        }
        
        // Dibujar rect√°ngulo
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, width, height);
        
        // Dibujar fondo para etiqueta
        ctx.fillStyle = color;
        const text = `${label} ${Math.round(confidence * 100)}%`;
        const textWidth = ctx.measureText(text).width;
        ctx.fillRect(x, y - 20, textWidth + 10, 20);
        
        // Dibujar texto
        ctx.fillStyle = 'white';
        ctx.font = '12px Arial';
        ctx.fillText(text, x + 5, y - 5);
        
        // Limpiar despu√©s de 3 segundos
        setTimeout(() => {
            if (ctx) {
                ctx.clearRect(x - 5, y - 25, textWidth + 20, height + 30);
            }
        }, 3000);
    }

    // Mostrar resultados de detecci√≥n
    function mostrarResultadosDeteccion(adultos, ni√±os, carros, detecciones) {
        if (adultos === 0 && ni√±os === 0 && carros === 0) {
            updateStatus("üëÅÔ∏è No se detectaron objetos", 'warning');
            alert("No se detectaron personas ni veh√≠culos. Aseg√∫rese de:\n1. Buena iluminaci√≥n\n2. Objetos claramente visibles\n3. Acercarse si es necesario");
            return;
        }
        
        const confianzaPromedio = detecciones.length > 0 ? 
            Math.round(detecciones.reduce((sum, d) => sum + d.confianza, 0) / detecciones.length * 100) : 0;
        
        const mensaje = `üéØ DETECCI√ìN COMPLETADA\n\n` +
                       `‚úÖ Adultos: ${adultos}\n` +
                       `üë∂ Ni√±os: ${ni√±os}\n` +
                       `üöó Veh√≠culos: ${carros}\n` +
                       `üìä Confianza: ${confianzaPromedio}%\n\n` +
                       `¬øAgregar al conteo total?`;
        
        if (confirm(mensaje)) {
            // Agregar al conteo
            counts.adultos += adultos;
            counts.ni√±os += ni√±os;
            counts.carros += carros;
            
            // Guardar en historial
            guardarEnHistorial(adultos, ni√±os, carros, detecciones);
            
            // Actualizar UI
            actualizarUI();
            
            // Efecto visual
            mostrarEfectoAgregado(adultos, ni√±os, carros);
            
            updateStatus(`‚úÖ ¬°${adultos+ni√±os} personas y ${carros} veh√≠culos agregados!`, 'success');
        } else {
            updateStatus("‚úÖ IA lista para nueva detecci√≥n");
            // Limpiar canvas
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
    }

    // Efecto visual al agregar
    function mostrarEfectoAgregado(a, n, c) {
        const elementos = [
            {id: 'adultos-val', show: a > 0},
            {id: 'ni√±os-val', show: n > 0},
            {id: 'carros-val', show: c > 0}
        ];
        
        elementos.forEach(item => {
            if (item.show) {
                const el = document.getElementById(item.id);
                el.style.color = '#27ae60';
                setTimeout(() => el.style.color = '#2c3e50', 1000);
            }
        });
    }

    // Guardar en historial
    function guardarEnHistorial(adultos, ni√±os, carros, detecciones = []) {
        const timestamp = new Date();
        historial.unshift({
            timestamp: timestamp.toISOString(),
            adultos: adultos,
            ni√±os: ni√±os,
            carros: carros,
            total: adultos + ni√±os,
            detecciones: detecciones.length,
            modo: document.getElementById('modo-deteccion').value
        });
        
        // Limitar historial
        if (historial.length > 10) historial = historial.slice(0, 10);
        
        // Mostrar historial
        mostrarHistorial();
        
        // Guardar en localStorage
        guardarEnStorage();
    }

    // Mostrar historial
    function mostrarHistorial() {
        const container = document.getElementById('historial-container');
        const lista = document.getElementById('historial-lista');
        
        if (historial.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        lista.innerHTML = '';
        
        historial.forEach((item, index) => {
            const fecha = new Date(item.timestamp);
            const hora = fecha.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div class="d-flex justify-content-between">
                    <small><strong>${hora}</strong></small>
                    <small class="text-muted">${fecha.toLocaleDateString()}</small>
                </div>
                <div class="mt-1">
                    <span class="badge-adult detection-badge">Adultos: ${item.adultos}</span>
                    <span class="badge-child detection-badge">Ni√±os: ${item.ni√±os}</span>
                    <span class="badge-car detection-badge">Veh√≠culos: ${item.carros}</span>
                </div>
            `;
            lista.appendChild(div);
        });
    }

    // Cambiar contadores manualmente
    function cambiar(tipo, valor) {
        const nuevoValor = counts[tipo] + valor;
        
        if (nuevoValor < 0) {
            alert("‚ùå El valor no puede ser negativo");
            return;
        }
        
        counts[tipo] = nuevoValor;
        actualizarUI();
        guardarEnStorage();
        
        // Feedback visual
        const elemento = document.getElementById(`${tipo}-val`);
        elemento.style.color = valor > 0 ? '#27ae60' : '#e74c3c';
        elemento.style.transform = 'scale(1.1)';
        setTimeout(() => {
            elemento.style.color = '';
            elemento.style.transform = 'scale(1)';
        }, 300);
    }

    // Actualizar toda la interfaz
    function actualizarUI() {
        // Actualizar contadores individuales
        document.getElementById('adultos-val').innerText = counts.adultos;
        document.getElementById('ni√±os-val').innerText = counts.ni√±os;
        document.getElementById('carros-val').innerText = counts.carros;
        
        // Actualizar totales
        const totalPersonas = counts.adultos + counts.ni√±os;
        document.getElementById('total-personas').innerText = totalPersonas;
        document.getElementById('total-carros').innerText = counts.carros;
        
        // Actualizar timestamp
        updateTimestamp();
    }

    // Alternar historial completo
    function toggleHistorial() {
        const lista = document.getElementById('historial-lista');
        const boton = document.querySelector('#historial-container button');
        
        if (lista.style.maxHeight && lista.style.maxHeight !== 'none') {
            lista.style.maxHeight = 'none';
            lista.style.overflow = 'visible';
            boton.textContent = 'Ver Menos';
        } else {
            lista.style.maxHeight = '200px';
            lista.style.overflow = 'auto';
            boton.textContent = 'Ver Todo';
        }
    }

    // Confirmar limpieza
    function confirmarLimpiar() {
        const total = counts.adultos + counts.ni√±os + counts.carros;
        
        if (total === 0) {
            alert("El conteo ya est√° en cero.");
            return;
        }
        
        const confirmacion = confirm(
            `‚ö†Ô∏è ¬øREINICIAR CONTEO?\n\n` +
            `Actualmente registrado:\n` +
            `üë• ${counts.adultos + counts.ni√±os} personas\n` +
            `üöó ${counts.carros} veh√≠culos\n\n` +
            `Esta acci√≥n no se puede deshacer.`
        );
        
        if (confirmacion) {
            counts = { adultos: 0, ni√±os: 0, carros: 0 };
            historial = [];
            detectionHistory = [];
            actualizarUI();
            document.getElementById('historial-container').style.display = 'none';
            localStorage.removeItem('iglesiaConteo');
            
            // Limpiar canvas
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            alert("‚úÖ Conteo reiniciado exitosamente.");
        }
    }

    // Exportar a CSV
    function exportarCSV() {
        const fecha = new Date();
        const fechaStr = fecha.toLocaleDateString().replace(/\//g, '-');
        const horaStr = fecha.toLocaleTimeString().replace(/:/g, '-');
        
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Encabezado
        csvContent += "REPORTE DE ASISTENCIA - IGLESIA IMPACTO PRO\r\n";
        csvContent += `Fecha de generaci√≥n: ${fecha.toLocaleString()}\r\n\r\n`;
        
        // Resumen general
        csvContent += "RESUMEN GENERAL\r\n";
        csvContent += "Categor√≠a,Cantidad\r\n";
        csvContent += `Adultos,${counts.adultos}\r\n`;
        csvContent += `Ni√±os,${counts.ni√±os}\r\n`;
        csvContent += `Total Personas,${counts.adultos + counts.ni√±os}\r\n`;
        csvContent += `Veh√≠culos,${counts.carros}\r\n\r\n`;
        
        // Historial
        if (historial.length > 0) {
            csvContent += "HISTORIAL DE DETECCIONES\r\n";
            csvContent += "Fecha,Hora,Adultos,Ni√±os,Veh√≠culos,Total,Modo\r\n";
            
            historial.forEach(item => {
                const d = new Date(item.timestamp);
                csvContent += `${d.toLocaleDateString()},${d.toLocaleTimeString()},${item.adultos},${item.ni√±os},${item.carros},${item.total},${item.modo}\r\n`;
            });
        }
        
        // Crear y descargar archivo
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `asistencia_${fechaStr}_${horaStr}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Feedback
        alert(`‚úÖ Reporte exportado exitosamente`);
    }

    // Guardar en localStorage
    function guardarEnStorage() {
        const data = {
            counts: counts,
            historial: historial,
            fechaGuardado: new Date().toISOString(),
            version: '2.2'
        };
        try {
            localStorage.setItem('iglesiaConteo', JSON.stringify(data));
        } catch (e) {
            console.warn("No se pudo guardar en localStorage:", e);
        }
    }

    // Cargar desde localStorage
    function cargarDesdeStorage() {
        try {
            const guardado = localStorage.getItem('iglesiaConteo');
            if (guardado) {
                const data = JSON.parse(guardado);
                counts = data.counts || counts;
                historial = data.historial || historial;
                actualizarUI();
                
                if (historial.length > 0) {
                    mostrarHistorial();
                }
                
                console.log("Datos cargados desde almacenamiento local");
            }
        } catch (e) {
            console.warn("Error cargando datos guardados:", e);
        }
    }

    // Actualizar informaci√≥n del sistema
    function updateSystemInfo() {
        const info = `IA: ${modoIA ? 'Disponible' : 'Manual'} | Navegador: ${navigator.userAgent.split(' ')[0]}`;
        document.getElementById('system-info').textContent = info;
    }

    // Inicializar aplicaci√≥n
    async function initApp() {
        console.log("Iniciando aplicaci√≥n...");
        
        // Inicializar elementos del DOM
        initDOMElements();
        
        // Cargar datos guardados
        cargarDesdeStorage();
        
        // Configurar c√°mara
        const cameraReady = await setupCamera();
        
        if (cameraReady) {
            // Configurar modelo de IA (si est√° disponible)
            await setupModel();
        } else {
            // Modo manual si no hay c√°mara
            modoIA = false;
            document.getElementById('manual-mode-alert').style.display = 'block';
            btnIcon.textContent = "üëÅÔ∏è";
            btnText.textContent = "Modo Manual";
            btnDetectar.disabled = false;
        }
        
        // Actualizar informaci√≥n del sistema
        updateSystemInfo();
        
        console.log("Aplicaci√≥n inicializada");
    }

    // Limpiar recursos
    window.addEventListener('beforeunload', () => {
        if (video && video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        guardarEnStorage();
    });

    // Auto-guardar
    setInterval(guardarEnStorage, 30000); // Cada 30 segundos

    // Iniciar cuando cargue la p√°gina
    window.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
